---
import type { GetStaticPaths, Page } from 'astro'
import type { CollectionEntry } from 'astro:content'
import { getCollection } from 'astro:content'
import { POSTS_CONFIG } from '~/config'
import { postsSort } from '~/lib/utils'
import Layout from '~/layouts/Layout.astro'
import Pagination from '~/components/Pagination.astro'
import PostCardList from '~/components/postCard/PostCardList.astro'

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allPosts = await getCollection('posts')
  const sortedPosts = postsSort(allPosts)
  const uniqueTags = [...new Set(sortedPosts.flatMap((post) => post.data.tags || []))]

  return uniqueTags
    .map((tag) => {
      const tagPosts = sortedPosts.filter((post) => post.data.tags?.includes(tag))
      return paginate(tagPosts, {
        params: { tag },
        props: { tag },
        pageSize: POSTS_CONFIG.tagsPageConfig.size,
      })
    })
    .flat()
}

interface Props {
  page: Page<CollectionEntry<'posts'>>
  tag: string
}

const { page, tag } = Astro.props
const description = `Posts with the tag #${tag}`
---

<Layout title={`#${tag}`} {description}>
  <div class="fullPage relative z-[1] py-8 pb-10 px-8">
    <div class="mb-8 md:mb-10">
      <div class="flex items-center gap-2 text-sm md:text-base">
        <a href="/tags" class="group flex items-center text-muted-foreground hover:text-primary transition-colors">
          <span class="icon-[ph--arrow-left] mr-2 transition-transform group-hover:-translate-x-0.5"></span>
          <span>All Tags</span>
        </a>
        <span class="text-muted-foreground">/</span>
        <h1 class="flex items-center gap-2 font-bold text-primary" style={`view-transition-name: tag-${tag.replace(/\s+/g, '-')}`}>
          <span class="icon-[ph--tag] text-primary/80"></span>
          {tag}
        </h1>
      </div>
      <p class="mt-2 text-sm text-muted-foreground/80">
        Browsing <span class="font-medium text-primary">{page.total}</span>
        {page.total === 1 ? 'article' : 'articles'} in this category
      </p>
    </div>

    <div class="fade-up space-y-8">
      <PostCardList
        posts={page.data}
        type={POSTS_CONFIG.tagsPageConfig.type}
        heroImageLayout={POSTS_CONFIG.tagsPageConfig?.heroImageLayout}
      />
    </div>

    <Pagination {page} baseUrl={`/tags/${tag}`} class="mt-12" />
  </div>
</Layout>
